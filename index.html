<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e40af">
  <meta name="description" content="Gestione veicoli aziendali con tracking tempo">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Gestione Veicoli Aziendali</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; overscroll-behavior-y: contain; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      padding-bottom: 50px; /* Spazio extra per scroll */
    }

    /* HEADER & NAV */
    .header { text-align: center; color: white; margin-bottom: 20px; }
    .header h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
    .nav-tabs {
      display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;
      position: sticky; top: 0; z-index: 90;
      background: rgba(102, 126, 234, 0.95); padding: 10px 0; backdrop-filter: blur(5px);
    }
    .nav-tabs button {
      padding: 10px 20px; background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3); color: white;
      border-radius: 10px; font-weight: 600; font-size: 14px;
    }
    .nav-tabs button.active { background: white; color: #667eea; }

    /* LAYOUT */
    .container { display: flex; flex-direction: column; gap: 15px; max-width: 1400px; margin: 0 auto; }
    .column { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .column h2 { color: #1e293b; margin-bottom: 15px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }

    /* PERSONE */
    #people-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
    .person {
      padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border-radius: 12px; font-weight: 600;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      user-select: none; -webkit-user-select: none; touch-action: none;
      min-height: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative;
    }
    .person::before { content: "üë§"; font-size: 1.2rem; }
    
    /* GHOST DRAG */
    .drag-ghost {
      position: fixed; pointer-events: none; z-index: 1000; opacity: 0.9;
      box-shadow: 0 15px 30px rgba(0,0,0,0.4); transform: scale(1.1) rotate(-3deg);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border-radius: 12px; padding: 15px; font-weight: 600;
      display: flex; align-items: center; justify-content: center; gap: 8px; width: 140px;
    }
    .drag-ghost::before { content: "üë§"; font-size: 1.2rem; }
    .person.dragging-placeholder { opacity: 0.3; background: #e2e8f0; border: 2px dashed #cbd5e1; color: transparent; }
    .person.dragging-placeholder::before { content: ""; }

    /* VEICOLI */
    .vehicle { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 15px; margin-bottom: 15px; border-radius: 16px; border: 2px solid #e2e8f0; }
    .vehicle-header { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
    .vehicle-icon { font-size: 2.5rem; }
    .vehicle-info h3 { font-size: 1.2rem; margin-bottom: 3px; color: #1e293b; }
    .vehicle-info .license { color: #64748b; font-size: 0.85rem; }

    /* DROPZONE */
    .dropzone {
      min-height: 80px; background: white; border: 3px dashed #cbd5e1;
      border-radius: 12px; padding: 10px; margin: 12px 0;
      display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .dropzone.drag-over { border-color: #667eea; background: #eff6ff; transform: scale(1.02); }
    .dropzone:empty::before { content: "Trascina qui"; color: #94a3b8; font-style: italic; width: 100%; text-align: center; }

    /* STILE PERSONA DENTRO DROPZONE (con tasto X) */
    .dropzone .person {
      font-size: 0.85rem; padding: 8px 12px; margin: 0; min-height: auto;
      cursor: default; position: relative; padding-right: 25px; /* Spazio per la X */
    }
    
    /* TASTO X DI RIMOZIONE */
    .remove-btn {
      position: absolute; top: -8px; right: -8px;
      width: 22px; height: 22px; background: #ef4444; color: white;
      border-radius: 50%; font-size: 16px; line-height: 20px;
      text-align: center; cursor: pointer; font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid white;
    }

    /* CONTROLLI E TIMER */
    .timer-display { text-align: center; font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 12px 0; font-family: monospace; }
    .timer-display.running { color: #22c55e; }
    .controls { display: flex; gap: 8px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 600; color: white; text-transform: uppercase; }
    .btn-start { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
    .btn-stop { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .btn:disabled { opacity: 0.5; }

    /* REPORT E TABELLE */
    .report-section { display: none; }
    .report-section.active { display: block; }
    .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filters select, .filters button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; flex: 1; }
    .report-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white; }
    .report-table th, .report-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    .report-table th { background: #f8fafc; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>

  <div class="header">
    <h1>üöó GearOne</h1>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
    <button class="tab-btn" data-tab="report">Report</button>
  </div>

  <div id="dashboard" class="tab-content active">
    <div class="container">
      <div class="column">
        <h2>üë• Personale</h2>
        <div id="people-list">
          <div class="person" data-name="Luca">Luca</div>
          <div class="person" data-name="Filippo">Filippo</div>
          <div class="person" data-name="Gabri">Gabri</div>
          <div class="person" data-name="Damiano">Damiano</div>
          <div class="person" data-name="Simone">Simone</div>
          <div class="person" data-name="Nicola">Nicola</div>
        </div>
      </div>

      <div class="column">
        <h2>üöô Parco Auto</h2>
        <div class="vehicle" data-vehicle="dacia">
          <div class="vehicle-header">
            <div class="vehicle-icon">üöê</div>
            <div class="vehicle-info"><h3>Dacia Dokker</h3><div class="license">AB 123 CD</div></div>
          </div>
          <div class="dropzone"></div>
          <div class="timer-display">00:00:00</div>
          <div class="controls"><button class="btn btn-start">Start</button><button class="btn btn-stop" disabled>Stop</button></div>
        </div>

        <div class="vehicle" data-vehicle="fiat">
          <div class="vehicle-header">
            <div class="vehicle-icon">üöó</div>
            <div class="vehicle-info"><h3>Fiat 500L</h3><div class="license">EF 456 GH</div></div>
          </div>
          <div class="dropzone"></div>
          <div class="timer-display">00:00:00</div>
          <div class="controls"><button class="btn btn-start">Start</button><button class="btn btn-stop" disabled>Stop</button></div>
        </div>

        <div class="vehicle" data-vehicle="peugeot">
          <div class="vehicle-header">
            <div class="vehicle-icon">üöô</div>
            <div class="vehicle-info"><h3>Peugeot</h3><div class="license">IJ 789 KL</div></div>
          </div>
          <div class="dropzone"></div>
          <div class="timer-display">00:00:00</div>
          <div class="controls"><button class="btn btn-start">Start</button><button class="btn btn-stop" disabled>Stop</button></div>
        </div>
      </div>
    </div>
  </div>

  <div id="report" class="tab-content report-section">
    <div class="column">
      <h2>üìä Report</h2>
      <div class="filters">
        <select id="filter-vehicle"><option value="">Tutti Veicoli</option><option value="dacia">Dacia</option><option value="fiat">Fiat</option><option value="peugeot">Peugeot</option></select>
        <button id="export-csv" style="background:#667eea; color:white;">CSV</button>
        <button id="clear-data" style="background:#ef4444; color:white;">Reset</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="report-table">
          <thead><tr><th>Veicolo</th><th>Chi</th><th>Inizio</th><th>Fine</th><th>Durata</th></tr></thead>
          <tbody id="report-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// --- SERVICE WORKER ---
if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(()=>{});

// --- VARIABILI GLOBALI ---
const timers = {};
const DB_KEY = 'vehicle-usage-data';

// --- NAVIGAZIONE TAB ---
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    if(btn.dataset.tab === 'report') loadReport();
  });
});

// ==========================================
//   CORE DRAG & DROP + AUTO-SCROLL FIX
// ==========================================

let ghost = null;
let dragSource = null; // L'elemento originale che stiamo trascinando
let isDragging = false;

// Variabili per l'Auto-Scroll
let autoScrollSpeed = 0;
let autoScrollAnimation = null;
let currentTouchY = 0;

// --- FUNZIONE LOOP SCROLL ---
// Questa funzione gira sempre quando stai trascinando.
// Se autoScrollSpeed √® diverso da 0, scrolla la pagina.
function performAutoScroll() {
  if (isDragging && autoScrollSpeed !== 0) {
    window.scrollBy(0, autoScrollSpeed);
  }
  if (isDragging) {
    requestAnimationFrame(performAutoScroll);
  }
}

// 1. TOUCH START
document.addEventListener('touchstart', (e) => {
  const target = e.target.closest('.person');
  // Inizia solo se tocchi una persona nella lista sorgente (non nella dropzone)
  if (target && target.parentElement.id === 'people-list') {
    isDragging = true;
    dragSource = target;
    currentTouchY = e.touches[0].clientY;
    
    // Avvia il loop di controllo scroll
    autoScrollSpeed = 0;
    requestAnimationFrame(performAutoScroll);
  }
}, { passive: false });

// 2. TOUCH MOVE
document.addEventListener('touchmove', (e) => {
  if (!isDragging || !dragSource) return;
  e.preventDefault(); // IMPORTANTE: Blocca lo scroll nativo per gestire il drag manualmente

  const touch = e.touches[0];
  currentTouchY = touch.clientY;
  
  // --- CALCOLO ZONA DI SCROLL ---
  const screenH = window.innerHeight;
  const edgeSize = 100; // Pixel dal bordo per attivare lo scroll
  const maxSpeed = 15;

  if (currentTouchY > screenH - edgeSize) {
    // Vicino al fondo -> scendi
    // Pi√π vai gi√π, pi√π veloce scrolla
    const intensity = (currentTouchY - (screenH - edgeSize)) / edgeSize;
    autoScrollSpeed = maxSpeed * intensity; 
  } else if (currentTouchY < edgeSize) {
    // Vicino alla cima -> sali
    const intensity = (edgeSize - currentTouchY) / edgeSize;
    autoScrollSpeed = -maxSpeed * intensity;
  } else {
    // Nel mezzo -> fermo
    autoScrollSpeed = 0;
  }

  // --- GESTIONE FANTASMA ---
  if (!ghost) {
    ghost = document.createElement('div');
    ghost.className = 'drag-ghost';
    ghost.textContent = dragSource.textContent;
    document.body.appendChild(ghost);
    dragSource.classList.add('dragging-placeholder');
  }

  ghost.style.left = (touch.clientX - 70) + 'px';
  ghost.style.top = (touch.clientY - 30) + 'px';

  // --- HIGHLIGHT DROPZONE ---
  const elBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  const dropzone = elBelow ? elBelow.closest('.dropzone') : null;
  document.querySelectorAll('.dropzone').forEach(z => z.classList.remove('drag-over'));
  if (dropzone) dropzone.classList.add('drag-over');

}, { passive: false });

// 3. TOUCH END
document.addEventListener('touchend', (e) => {
  if (!isDragging) return;
  
  const touch = e.changedTouches[0];
  const elBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  const dropzone = elBelow ? elBelow.closest('.dropzone') : null;

  if (dropzone && dragSource) {
    dropPersonIntoZone(dragSource.dataset.name, dropzone);
  }

  // CLEANUP
  if (ghost) { ghost.remove(); ghost = null; }
  if (dragSource) {
    dragSource.classList.remove('dragging-placeholder');
    dragSource = null;
  }
  document.querySelectorAll('.dropzone').forEach(z => z.classList.remove('drag-over'));
  isDragging = false;
  autoScrollSpeed = 0; // Ferma lo scroll loop
});

// --- LOGICA DI ASSEGNAZIONE (COMUNE TOUCH & MOUSE) ---
function dropPersonIntoZone(name, zone) {
  // Controlla duplicati
  let exists = false;
  document.querySelectorAll('.dropzone .person').forEach(p => { if(p.dataset.name === name) exists = true; });
  if(exists) return alert('‚ö†Ô∏è Persona gi√† assegnata!');

  // Trova originale
  const original = document.querySelector(`#people-list .person[data-name="${name}"]`);
  if(original) {
    // Crea clone nella dropzone
    const clone = document.createElement('div');
    clone.className = 'person';
    clone.dataset.name = name;
    clone.textContent = name;
    
    // AGGIUNTA TASTO X
    const removeBtn = document.createElement('span');
    removeBtn.className = 'remove-btn';
    removeBtn.innerHTML = '&times;';
    removeBtn.onclick = (e) => {
      e.stopPropagation(); // Evita click strani
      removePersonFromVehicle(name, clone);
    };
    clone.appendChild(removeBtn);

    zone.appendChild(clone);
    original.style.display = 'none'; // Nascondi dalla lista
  }
}

// Funzione per rimuovere persona (clic sulla X)
function removePersonFromVehicle(name, cloneElement) {
  cloneElement.remove();
  const original = document.querySelector(`#people-list .person[data-name="${name}"]`);
  if(original) original.style.display = 'flex';
}

// ==========================================
//   LOGICA TIMER & DB
// ==========================================
function formatTime(s) {
  return [Math.floor(s/3600), Math.floor((s%3600)/60), s%60].map(v => String(v).padStart(2,'0')).join(':');
}

function updateTimerDisplay(vid) {
  const el = document.querySelector(`.vehicle[data-vehicle="${vid}"] .timer-display`);
  if(timers[vid]) el.textContent = formatTime(Math.floor((Date.now() - timers[vid].start)/1000));
}

document.querySelectorAll('.vehicle').forEach(v => {
  const vid = v.dataset.vehicle;
  const btnStart = v.querySelector('.btn-start');
  const btnStop = v.querySelector('.btn-stop');
  const zone = v.querySelector('.dropzone');
  const display = v.querySelector('.timer-display');

  btnStart.addEventListener('click', () => {
    const people = Array.from(zone.querySelectorAll('.person')).map(p => p.dataset.name);
    if(!people.length) return alert('Inserisci qualcuno!');
    
    timers[vid] = { start: Date.now(), people, interval: setInterval(()=>updateTimerDisplay(vid), 1000) };
    btnStart.disabled = true; btnStop.disabled = false;
    display.classList.add('running');
  });

  btnStop.addEventListener('click', () => {
    clearInterval(timers[vid].interval);
    const end = Date.now();
    const dur = Math.floor((end - timers[vid].start)/1000);
    
    const rec = {
      vehicle: vid, 
      vName: v.querySelector('h3').textContent,
      people: timers[vid].people,
      start: timers[vid].start,
      end: end,
      dur: dur
    };
    
    const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]');
    db.push(rec);
    localStorage.setItem(DB_KEY, JSON.stringify(db));

    // Reset UI
    zone.innerHTML = ''; // Rimuovi tutti dal veicolo
    timers[vid].people.forEach(name => {
      const orig = document.querySelector(`#people-list .person[data-name="${name}"]`);
      if(orig) orig.style.display = 'flex';
    });

    delete timers[vid];
    btnStart.disabled = false; btnStop.disabled = true;
    display.classList.remove('running');
    display.textContent = '00:00:00';
    alert('‚úÖ Viaggio Salvato');
  });
});

// REPORT
function loadReport() {
  const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]');
  const vFilter = document.getElementById('filter-vehicle').value;
  const tbody = document.getElementById('report-body');
  
  const filtered = db.filter(r => !vFilter || r.vehicle === vFilter);
  
  tbody.innerHTML = filtered.map(r => `
    <tr>
      <td><b>${r.vName}</b></td>
      <td>${r.people.join(', ')}</td>
      <td>${new Date(r.start).toLocaleTimeString()}</td>
      <td>${new Date(r.end).toLocaleTimeString()}</td>
      <td>${formatTime(r.dur)}</td>
    </tr>
  `).join('');
}

document.getElementById('filter-vehicle').addEventListener('change', loadReport);
document.getElementById('clear-data').addEventListener('click', ()=>{ 
  if(confirm('Cancello tutto?')) { localStorage.removeItem(DB_KEY); loadReport(); }
});
document.getElementById('export-csv').addEventListener('click', ()=>{
  const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]');
  if(!db.length) return alert('No Data');
  let csv = "Veicolo,Chi,Inizio,Fine,Durata\n" + db.map(r => 
    `"${r.vName}","${r.people.join(';')}",${new Date(r.start).toLocaleString()},${new Date(r.end).toLocaleString()},${formatTime(r.dur)}`
  ).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'report.csv'; a.click();
});

</script>
</body>
</html>